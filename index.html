<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omar - Smart Abacus AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@700;900&display=swap');

        :root {
            --wood-frame: #3d2b1f;
            --bead-5: #3498db;
            --bead-1: #2ecc71;
            --bead-active: #f39c12;
            --beam: #2a1d15;
            --bead-h: 38px; 
        }

        /* Animated Gradient Background */
        body {
            background: linear-gradient(-45deg, #0f172a, #1e1b4b, #1e293b, #0f172a);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            font-family: 'Cairo', sans-serif;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px 10px;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .ai-controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-bottom: 20px; z-index: 100; }
        
        /* Styled Dropdown for Levels */
        .level-select {
            background: #1e293b;
            color: #fbbf24;
            border: 2px solid #8b5cf6;
            padding: 10px;
            border-radius: 15px;
            font-weight: bold;
            outline: none;
            cursor: pointer;
        }

        .ai-btn {
            background: #8b5cf6; color: white; padding: 12px 24px;
            border-radius: 15px; font-weight: 700; transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
            border: none; cursor: pointer;
        }
        .ai-btn:hover:not(:disabled) { transform: translateY(-2px); filter: brightness(1.1); }
        .ai-btn:disabled { background: #475569; cursor: not-allowed; box-shadow: none; opacity: 0.7; }

        .challenge-box {
            background: rgba(30, 41, 59, 0.9);
            border: 2px solid #8b5cf6;
            padding: 15px 30px;
            border-radius: 20px;
            margin-bottom: 10px;
            text-align: center;
            display: none;
            animation: fadeIn 0.3s ease;
            backdrop-filter: blur(5px);
        }

        /* Timer UI */
        .timer-container {
            display: none;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #fbbf24;
            padding: 8px 20px;
            border-radius: 50px;
            margin-bottom: 15px;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.3);
            animation: pulseTimer 2s infinite ease-in-out;
        }

        @keyframes pulseTimer {
            0% { transform: scale(1); box-shadow: 0 0 5px rgba(251, 191, 36, 0.3); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(251, 191, 36, 0.6); }
            100% { transform: scale(1); box-shadow: 0 0 5px rgba(251, 191, 36, 0.3); }
        }

        .timer-display {
            font-size: 1.2rem;
            color: #fbbf24;
            font-weight: 900;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .result-wrapper {
            background: rgba(30, 41, 59, 0.9);
            padding: 10px 25px;
            border-radius: 20px;
            border: 2px solid #fbbf24;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            backdrop-filter: blur(5px);
        }
        .result-value {
            font-size: 2.2rem;
            font-weight: 900;
            color: #fbbf24;
            min-width: 120px;
            text-align: center;
            opacity: 0; 
            transition: opacity 0.3s;
        }
        .result-value.show { opacity: 1; }

        .toggle-eye {
            cursor: pointer;
            background: #334155;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .abacus-container {
            background: var(--wood-frame);
            padding: 50px 15px 30px 15px;
            border: 12px solid #1a130e;
            border-radius: 25px;
            position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .middle-beam {
            position: absolute; left: 0; right: 0; top: 155px;
            height: 18px; background: var(--beam); z-index: 50;
            box-shadow: 0 2px 8px rgba(0,0,0,0.6);
        }

        .column { width: 75px; height: 520px; position: relative; }
        .column-title { position: absolute; top: -40px; width: 100%; text-align: center; font-size: 0.8rem; color: #94a3b8; font-weight: bold; }
        
        .rod { 
            position: absolute; left: 50%; transform: translateX(-50%); 
            width: 8px; height: 100%; 
            background: linear-gradient(to right, #64748b, #cbd5e1, #64748b); 
            z-index: 1; border-radius: 4px;
        }

        .bead {
            width: 68px; height: var(--bead-h);
            clip-path: polygon(15% 0%, 85% 0%, 100% 50%, 85% 100%, 15% 100%, 0% 50%);
            position: absolute; left: 3.5px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 60; border: 1px solid rgba(0,0,0,0.1);
        }
        .bead-text { font-weight: 900; font-size: 0.9rem; color: white; pointer-events: none; }

        .bead-5 { background: var(--bead-5); top: 15px; }
        .bead-5.active { transform: translateY(102px); background: var(--bead-active); }

        .bead-1 { background: var(--bead-1); }
        .idx-1 { top: 195px; }
        .idx-2 { top: 245px; }
        .idx-3 { top: 295px; }
        .idx-4 { top: 345px; }

        .idx-1.active { transform: translateY(-22px); background: var(--bead-active); }
        .idx-2.active { transform: translateY(-22px); background: var(--bead-active); }
        .idx-3.active { transform: translateY(-22px); background: var(--bead-active); }
        .idx-4.active { transform: translateY(-22px); background: var(--bead-active); }

        .reset-btn {
            margin-top: 25px; background: #e11d48; padding: 10px 50px;
            border-radius: 50px; font-weight: 900; font-size: 1.2rem;
            cursor: pointer; border: none; color: white; transition: all 0.2s;
        }
        .reset-btn:hover { filter: brightness(1.2); transform: scale(1.05); }

        .loader {
            border: 3px solid #f3f3f3; border-top: 3px solid #8b5cf6;
            border-radius: 50%; width: 20px; height: 20px;
            animation: spin 1s linear infinite; display: none; margin: 10px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            z-index: 1000; align-items: center; justify-content: center;
        }
        .modal-body {
            background: #1e293b; padding: 25px; border-radius: 20px;
            max-width: 400px; width: 90%; text-align: center; border: 2px solid #10b981;
        }
    </style>
</head>
<body>

    <div class="ai-controls">
        <select id="levelSelect" class="level-select">
            <option value="easy">حسبة سهلة (آحاد)</option>
            <option value="medium">حسبة متوسطة (مئات)</option>
            <option value="hard">حسبة صعبة (ألوف)</option>
            <option value="extreme">حسبة صعبة جداً (ملايين)</option>
        </select>
        <button class="ai-btn" id="challengeBtn" onclick="generateChallenge()">تحدي ذكي ✨</button>
        <button class="ai-btn" style="background:#10b981" id="tutorBtn" onclick="askTutor()">سؤال المدرب ✨</button>
    </div>

    <div id="challengeBox" class="challenge-box">
        <div id="challengeLoader" class="loader"></div>
        <p id="challengeText" class="text-xl font-bold text-blue-300"></p>
    </div>

    <div id="timerContainer" class="timer-container">
        <div class="timer-display">
            <span>⏱️</span>
            <span id="timerText">00:00</span>
        </div>
    </div>

    <div class="result-wrapper">
        <button class="toggle-eye" onclick="toggleVisibility()">
            <svg id="eyeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
                <line id="eyeLine" x1="1" y1="1" x2="23" y2="23" style="display:none"></line>
            </svg>
        </button>
        <div id="total" class="result-value">٠</div>
    </div>

    <div class="abacus-container">
        <div class="middle-beam"></div>
        <div id="rodsGrid" class="flex gap-2"></div>
    </div>

    <button class="reset-btn" onclick="resetAbacus()">تصفير المعداد</button>

    <div id="modal" onclick="this.style.display='none'">
        <div class="modal-body" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-3 text-green-400">نصيحة المدرب</h3>
            <div id="modalLoader" class="loader"></div>
            <p id="modalText"></p>
            <button class="mt-4 bg-gray-700 px-5 py-1 rounded-full" onclick="document.getElementById('modal').style.display='none'">إغلاق</button>
        </div>
    </div>

    <script>
        // ==========================================
        const apiKey = "AIzaSyByk6EEmf3i1qTDA6rCVU72VJ3EHH1PpSI"; 
        // ==========================================

        const arabicColumns = ["مليار", "١٠٠ مليون", "١٠ مليون", "مليون", "١٠٠ ألف", "١٠ آلاف", "ألف", "مئات", "عشرات", "آحاد"];
        let currentTotal = 0n;
        let isVisible = false;
        let targetValue = null;
        
        let startTime = null;
        let timerInterval = null;

        async function callAI(prompt, system) {
            if (!apiKey) return "خطأ: تأكد من وضع المفتاح في الكود.";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: system }] }
                    })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "عذراً، حاول مرة أخرى.";
            } catch (e) { return "حدث خطأ في الاتصال."; }
        }

        function startTimer() {
            startTime = new Date();
            document.getElementById('timerContainer').style.display = 'block';
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const now = new Date();
                const diff = Math.floor((now - startTime) / 1000);
                const mins = Math.floor(diff / 60).toString().padStart(2, '0');
                const secs = (diff % 60).toString().padStart(2, '0');
                document.getElementById('timerText').innerText = `${mins}:${secs}`;
            }, 1000);
        }

        async function generateChallenge() {
            const box = document.getElementById('challengeBox');
            const text = document.getElementById('challengeText');
            const loader = document.getElementById('challengeLoader');
            const btn = document.getElementById('challengeBtn');
            const level = document.getElementById('levelSelect').value;
            
            // Disable button during challenge
            btn.disabled = true;
            box.style.display = 'block';
            text.innerText = "";
            loader.style.display = 'block';

            let levelInstruction = "";
            switch(level) {
                case "easy": levelInstruction = "أعطني رقم عشوائي بين 1 و 9."; break;
                case "medium": levelInstruction = "أعطني رقم عشوائي بين 100 و 999."; break;
                case "hard": levelInstruction = "أعطني رقم عشوائي بين 1000 و 9999."; break;
                case "extreme": levelInstruction = "أعطني رقم عشوائي بالملايين."; break;
            }

            const res = await callAI(
                levelInstruction,
                "أنت معلم معداد. رد فقط بـ: 'مثل الرقم [الرقم بالارقام العربية 123] ✨' ولا تزد حرفاً واحداً."
            );

            loader.style.display = 'none';
            text.innerText = res;
            
            const match = res.match(/\d+/);
            if(match) {
                targetValue = BigInt(match[0]);
                startTimer(); 
            } else {
                btn.disabled = false; // Re-enable if AI fails to give a number
            }
        }

        async function askTutor() {
            const modal = document.getElementById('modal');
            const mText = document.getElementById('modalText');
            const loader = document.getElementById('modalLoader');

            modal.style.display = 'flex';
            mText.innerText = "";
            loader.style.display = 'block';

            const isCorrect = (currentTotal === targetValue);
            let timeStr = "";
            
            if (isCorrect && startTime) {
                clearInterval(timerInterval);
                const endTime = new Date();
                const duration = Math.floor((endTime - startTime) / 1000);
                timeStr = ` لقد حللتها بنجاح في ${duration} ثانية!`;
                startTime = null; 
                // Enable challenge button again after correct answer
                document.getElementById('challengeBtn').disabled = false;
            }

            const res = await callAI(
                `الرقم الحالي ${currentTotal}. التحدي ${targetValue}. هل الحل صحيح؟ ${isCorrect ? 'نعم وصحيح تماماً.' : 'لا، الحل خطأ.'} أضف هذه الجملة في النهاية لو كان صحيحاً: ${timeStr}`,
                "أنت مدرب معداد. إذا كان الحل صحيحاً، هنئه بحماس شديد واذكر الوقت المستغرق. إذا كان خطأ، شجعه بلطف على المحاولة مرة أخرى."
            );

            loader.style.display = 'none';
            mText.innerText = res;
        }

        function toggleVisibility() {
            isVisible = !isVisible;
            document.getElementById('total').classList.toggle('show', isVisible);
            document.getElementById('eyeLine').style.display = isVisible ? 'none' : 'block';
        }

        function initAbacus() {
            const grid = document.getElementById('rodsGrid');
            grid.innerHTML = '';
            arabicColumns.forEach((name, i) => {
                const col = document.createElement('div');
                col.className = 'column';
                col.innerHTML = `
                    <div class="column-title">${name}</div>
                    <div class="rod"></div>
                    <div class="bead bead-5" onclick="toggleBead(this)"><span class="bead-text">5</span></div>
                    <div class="bead bead-1 idx-1" onclick="handleLower(this, 1)"><span class="bead-text">1</span></div>
                    <div class="bead bead-1 idx-2" onclick="handleLower(this, 2)"><span class="bead-text">1</span></div>
                    <div class="bead bead-1 idx-3" onclick="handleLower(this, 3)"><span class="bead-text">1</span></div>
                    <div class="bead bead-1 idx-4" onclick="handleLower(this, 4)"><span class="bead-text">1</span></div>
                `;
                grid.appendChild(col);
            });
        }

        function toggleBead(el) {
            el.classList.toggle('active');
            updateScore();
        }

        function handleLower(el, idx) {
            const column = el.parentElement;
            const beads = column.querySelectorAll('.bead-1');
            const isActive = el.classList.contains('active');

            beads.forEach((b, i) => {
                const bIdx = i + 1;
                if (!isActive && bIdx <= idx) b.classList.add('active');
                else if (isActive && bIdx >= idx) b.classList.remove('active');
            });
            updateScore();
        }

        function updateScore() {
            let total = 0n;
            const cols = document.querySelectorAll('.column');
            cols.forEach((col, i) => {
                let val = 0;
                if(col.querySelector('.bead-5').classList.contains('active')) val += 5;
                val += col.querySelectorAll('.bead-1.active').length;
                total += BigInt(val) * (10n ** BigInt(arabicColumns.length - 1 - i));
            });
            currentTotal = total;
            document.getElementById('total').innerText = currentTotal.toLocaleString('ar-EG');
        }

        function resetAbacus() {
            document.querySelectorAll('.bead').forEach(b => b.classList.remove('active'));
            updateScore();
            document.getElementById('challengeBox').style.display = 'none';
            document.getElementById('timerContainer').style.display = 'none';
            document.getElementById('challengeBtn').disabled = false; // Re-enable on reset
            clearInterval(timerInterval);
            startTime = null;
        }

        window.onload = initAbacus;
    </script>
</body>
</html>
