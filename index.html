<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omar - El Mo3dad Smart AI</title>
    <link rel="icon" type="image/jpeg" href="https://static.vecteezy.com/system/resources/thumbnails/054/242/702/small/strategy-line-multi-color-design-vector.jpg">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@700;900&display=swap');

        :root {
            --wood-frame: #3d2b1f;
            --bead-5: #3498db;
            --bead-1: #2ecc71;
            --bead-active: #f39c12;
            --beam: #2a1d15;
            --bead-h: 44px;
        }

        body {
            background: linear-gradient(-45deg, #0f172a, #1e1b4b, #312e81, #1e293b);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            font-family: 'Cairo', sans-serif;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px 10px;
            overflow-x: hidden;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .shapes-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: -1; overflow: hidden;
        }
        .shape {
            position: absolute; background: rgba(255, 255, 255, 0.03);
            border-radius: 50%; animation: float 20s linear infinite;
        }
        @keyframes float {
            0% { transform: translateY(110vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.3; }
            90% { opacity: 0.3; }
            100% { transform: translateY(-20vh) rotate(360deg); opacity: 0; }
        }

        .ai-controls { display: flex; gap: 10px; margin-bottom: 15px; z-index: 100; }
        .ai-btn {
            background: #8b5cf6; color: white; padding: 10px 20px;
            border-radius: 15px; font-weight: 700; transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
            display: flex; align-items: center; gap: 8px;
        }
        .ai-btn:hover { transform: translateY(-2px); background: #7c3aed; }
        .ai-btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .challenge-box {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            padding: 15px 25px; border-radius: 20px; margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.2); text-align: center;
            max-width: 600px; width: 90%; display: none; z-index: 100;
        }

        .result-wrapper {
            display: flex; align-items: center; gap: 15px; margin-bottom: 20px;
            background: rgba(30, 41, 59, 0.9); padding: 10px 25px;
            border-radius: 20px; border: 2px solid rgba(251, 191, 36, 0.3);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 100;
        }
        .result-value {
            font-size: 2.5rem; font-weight: 900; color: #fbbf24;
            min-width: 140px; text-align: center; visibility: hidden;
        }
        .result-value.show { visibility: visible; }
        .toggle-eye { cursor: pointer; background: #334155; border: none; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; transition: background 0.3s; }
        .toggle-eye:hover { background: #475569; }

        .abacus-container {
            background: var(--wood-frame); padding: 50px 20px 30px 20px;
            border: 15px solid #1a130e; border-radius: 30px;
            position: relative; box-shadow: 0 25px 60px rgba(0,0,0,0.6);
            display: inline-block;
        }

        .middle-beam {
            position: absolute; left: 0; right: 0; top: 180px;
            height: 24px; background: var(--beam); z-index: 50;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .column { width: 85px; height: 560px; position: relative; display: flex; flex-direction: column; }
        .column-title { position: absolute; top: -45px; font-weight: 900; color: #cbd5e1; font-size: 0.85rem; text-align: center; width: 100%; }
        .rod { position: absolute; left: 50%; transform: translateX(-50%); width: 10px; height: 100%; background: linear-gradient(to right, #94a3b8, #f8fafc, #64748b); border-radius: 5px; z-index: 1; }

        .upper-room { height: 180px; width: 100%; position: relative; z-index: 60; }
        .lower-room { height: 356px; margin-top: 24px; width: 100%; position: relative; z-index: 60; }

        .bead {
            width: 80px; height: var(--bead-h);
            clip-path: polygon(20% 0%, 80% 0%, 100% 50%, 80% 100%, 20% 100%, 0% 50%);
            position: absolute; left: 2.5px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            z-index: 70;
            user-select: none;
        }
        .bead-text { font-weight: 900; font-size: 1.2rem; color: white; pointer-events: none; }

        .bead-5 { background: var(--bead-5); top: 10px; }
        .bead-5.active { transform: translateY(120px); background: var(--bead-active); }

        .bead-1 { background: var(--bead-1); }
        .idx-1 { top: 80px; }
        .idx-2 { top: 130px; }
        .idx-3 { top: 180px; }
        .idx-4 { top: 230px; }

        .idx-1.active { transform: translateY(-75px); background: var(--bead-active); }
        .idx-2.active { transform: translateY(-75px); background: var(--bead-active); }
        .idx-3.active { transform: translateY(-75px); background: var(--bead-active); }
        .idx-4.active { transform: translateY(-75px); background: var(--bead-active); }

        .reset-btn {
            margin: 30px 0; background: #e11d48; padding: 12px 60px;
            border-radius: 50px; font-weight: 900; font-size: 1.4rem;
            cursor: pointer; transition: 0.2s; box-shadow: 0 5px 15px rgba(225, 29, 72, 0.4);
        }
        .reset-btn:hover { background: #fb7185; transform: scale(1.05); }

        #aiModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 200; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: #1e293b; padding: 30px; border-radius: 25px; max-width: 500px; width: 100%; border: 2px solid #8b5cf6; text-align: center; box-shadow: 0 0 30px rgba(139, 92, 246, 0.3); }

        /* Loader Styles */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8b5cf6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none;
            margin: 10px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>

<body>

    <div class="shapes-container" id="shapes"></div>

    <div class="ai-controls">
        <button class="ai-btn" id="challengeBtn" onclick="generateChallenge()">تحدي ذكي ✨</button>
        <button class="ai-btn" id="tutorBtn" style="background:#10b981" onclick="askTutor()">سؤال المدرب ✨</button>
    </div>

    <div id="challengeBox" class="challenge-box">
        <div id="challengeLoader" class="loader"></div>
        <p id="challengeText" class="text-xl font-bold"></p>
    </div>

    <div class="result-wrapper">
        <button class="toggle-eye" id="toggleEyeBtn" onclick="toggleResult()" title="إظهار/إخفاء النتيجة">
            <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
                <line id="eyeLine" x1="1" y1="1" x2="23" y2="23" style="display: block;"></line>
            </svg>
        </button>
        <div class="result-value" id="total">٠</div>
    </div>

    <div class="overflow-x-auto w-full flex justify-start lg:justify-center p-4">
        <div class="abacus-container">
            <div class="middle-beam"></div>
            <div id="rodsGrid" class="flex gap-3"></div>
        </div>
    </div>

    <button class="reset-btn" onclick="resetAbacus()">تصفير المعداد</button>

    <div id="aiModal" onclick="this.style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-black mb-4 text-purple-400">المدرب الذكي ✨</h2>
            <div id="modalLoader" class="loader"></div>
            <p id="modalText" class="text-lg"></p>
            <button class="mt-6 bg-purple-600 px-6 py-2 rounded-full font-bold hover:bg-purple-500 transition-colors" onclick="document.getElementById('aiModal').style.display='none'">فهمت</button>
        </div>
    </div>

    <script>
        // لرفع المشروع على جيت هب، يفضل وضع المفتاح في مكان آمن أو طلبه من المستخدم
        // البيئة الحالية توفر المفتاح تلقائياً عند التشغيل هنا
        const apiKey = ""; 
        const grid = document.getElementById('rodsGrid');
        const totalDisplay = document.getElementById('total');
        const eyeLine = document.getElementById('eyeLine');
        const arabicColumns = ["مليار", "١٠٠ مليون", "١٠ مليون", "مليون", "١٠٠ ألف", "١٠ آلاف", "ألف", "مئات", "عشرات", "آحاد"];

        let currentTotal = 0n;
        let isVisible = false;
        let targetValue = null;

        // دالة نداء الذكاء الاصطناعي مع معالجة الأخطاء المتقدمة والتكرار
        async function callGemini(prompt, system) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            contents: [{ parts: [{ text: prompt }] }], 
                            systemInstruction: { parts: [{ text: system }] } 
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        return data.candidates?.[0]?.content?.parts?.[0]?.text || "لم أستطع الحصول على إجابة.";
                    }
                    
                    if (response.status === 429) { // Too Many Requests
                         await new Promise(res => setTimeout(res, Math.pow(2, i) * 1000));
                         continue;
                    }
                } catch (e) {
                    await new Promise(res => setTimeout(res, Math.pow(2, i) * 1000));
                }
            }
            return "عذراً، يبدو أن هناك مشكلة في الاتصال بالسيرفر. يرجى التحقق من مفتاح الـ API أو حالة الإنترنت.";
        }

        async function generateChallenge() {
            const box = document.getElementById('challengeBox');
            const text = document.getElementById('challengeText');
            const loader = document.getElementById('challengeLoader');
            const btn = document.getElementById('challengeBtn');

            box.style.display = 'block';
            text.innerText = "";
            loader.style.display = 'block';
            btn.disabled = true;
            
            const res = await callGemini(
                "اطلب من الطفل تمثيل رقم عشوائي بين 10 و 1000 باللغة العربية بأسلوب مشجع ومرح جداً.", 
                "أنت معلم معداد خبير ولطيف جداً مع الأطفال، استخدم الرموز التعبيرية."
            );
            
            loader.style.display = 'none';
            text.innerText = res;
            btn.disabled = false;
            
            const match = res.match(/\d+/);
            if(match) targetValue = BigInt(match[0]);
        }

        async function askTutor() {
            const modal = document.getElementById('aiModal');
            const modalText = document.getElementById('modalText');
            const loader = document.getElementById('modalLoader');
            const btn = document.getElementById('tutorBtn');

            modal.style.display = 'flex';
            modalText.innerText = "";
            loader.style.display = 'block';
            btn.disabled = true;
            
            const res = await callGemini(
                `الرقم الحالي على المعداد هو: ${currentTotal}. الرقم المطلوب منه (التحدي) هو: ${targetValue || 'غير محدد بعد'}.`, 
                "أنت مدرب ذكي ومحفز، انظر للرقم الحالي وشجع الطفل. إذا كان الرقم صحيحاً فاحتفل به، وإذا كان خطأ وجهه بلطف للخانة التي قد يكون أخطأ فيها دون إعطائه الإجابة مباشرة."
            );
            
            loader.style.display = 'none';
            modalText.innerText = res;
            btn.disabled = false;
        }

        function toggleResult() {
            isVisible = !isVisible;
            totalDisplay.classList.toggle('show', isVisible);
            eyeLine.style.display = isVisible ? 'none' : 'block';
        }

        function initAbacus() {
            grid.innerHTML = '';
            arabicColumns.forEach((name) => {
                const col = document.createElement('div');
                col.className = 'column';
                col.innerHTML = `
                    <div class="column-title">${name}</div>
                    <div class="rod"></div>
                    <div class="upper-room">
                        <div class="bead bead-5" onclick="this.classList.toggle('active'); updateScore();" role="button" aria-label="خرزة 5"><span class="bead-text">5</span></div>
                    </div>
                    <div class="lower-room">
                        <div class="bead bead-1 idx-1" onclick="handleLower(this, 1)" role="button" aria-label="خرزة 1"><span class="bead-text">1</span></div>
                        <div class="bead bead-1 idx-2" onclick="handleLower(this, 2)" role="button" aria-label="خرزة 1"><span class="bead-text">1</span></div>
                        <div class="bead bead-1 idx-3" onclick="handleLower(this, 3)" role="button" aria-label="خرزة 1"><span class="bead-text">1</span></div>
                        <div class="bead bead-1 idx-4" onclick="handleLower(this, 4)" role="button" aria-label="خرزة 1"><span class="bead-text">1</span></div>
                    </div>
                `;
                grid.appendChild(col);
            });
        }

        function handleLower(el, idx) {
            const beads = el.parentElement.querySelectorAll('.bead-1');
            const state = el.classList.contains('active');
            beads.forEach((b, i) => {
                const bPos = i + 1;
                if(!state && bPos <= idx) b.classList.add('active');
                else if(state && bPos >= idx) b.classList.remove('active');
            });
            updateScore();
        }

        function updateScore() {
            let res = 0n;
            const columns = document.querySelectorAll('.column');
            columns.forEach((col, i) => {
                let v = 0;
                if(col.querySelector('.bead-5').classList.contains('active')) v += 5;
                v += col.querySelectorAll('.bead-1.active').length;
                res += BigInt(v) * (10n ** BigInt(arabicColumns.length - 1 - i));
            });
            currentTotal = res;
            totalDisplay.innerText = currentTotal.toLocaleString('ar-EG');
        }

        function resetAbacus() {
            document.querySelectorAll('.bead').forEach(b => b.classList.remove('active'));
            updateScore();
            document.getElementById('challengeBox').style.display = 'none';
            targetValue = null;
        }

        // إنشاء عناصر الخلفية المتحركة
        const shapesContainer = document.getElementById('shapes');
        for(let i=0; i<15; i++) {
            const s = document.createElement('div');
            s.className = 'shape';
            const size = Math.random()*50 + 20;
            s.style.width = size+'px'; s.style.height = size+'px';
            s.style.left = Math.random()*100+'%';
            s.style.animationDuration = (Math.random()*10 + 10)+'s';
            s.style.animationDelay = Math.random()*10+'s';
            shapesContainer.appendChild(s);
        }

        // بدء التشغيل
        window.onload = () => {
            initAbacus();
            updateScore();
        };
    </script>
</body>
</html>
